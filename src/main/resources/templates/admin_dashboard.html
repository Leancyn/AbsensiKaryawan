<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel Absensi</title>
    <link rel="stylesheet" href="/css/admin.css" />
  </head>
  <body>
    <div class="header-container">
      <h2>Admin Panel Absensi</h2>
      <button id="logoutBtn">Logout</button>
    </div>

    <table id="absensiTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Foto</th>
          <th>Lokasi</th>
          <th>Waktu</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      async function loadAbsensi() {
        const res = await fetch("/api/absensi/all");
        const data = await res.json();
        const tbody = document.querySelector("#absensiTable tbody");
        tbody.innerHTML = "";

        data.forEach((a) => {
          const tr = document.createElement("tr");
          const fotoSource = a.fotoUrl || a.fotoBase64 || "";

          const statusBadge = `<span class="status-badge ${a.status.toLowerCase()}">${a.status}</span>`;

          tr.innerHTML = `
                    <td data-label="ID">${a.id}</td>
                    <td data-label="User">${a.userNama}</td>
                    <td data-label="Foto">${fotoSource ? `<img src="${fotoSource}" alt="Foto Absensi" />` : "Tidak ada"}</td>
                    <td data-label="Lokasi">
                        <a href="https://maps.google.com/maps?q=${a.latitude},${a.longitude}" target="_blank">
                            ${a.latitude.toFixed(6)}, ${a.longitude.toFixed(6)}
                        </a>
                    </td>
                    <td data-label="Waktu">${new Date(a.timestamp).toLocaleString()}</td>
                    <td data-label="Status">${statusBadge}</td>
                    <td data-label="Aksi">
                        ${
                          a.status.toLowerCase() === "pending"
                            ? `<button onclick="updateStatus(${a.id}, 'approve')">Approve</button>
                               <button onclick="updateStatus(${a.id}, 'reject')">Reject</button>`
                            : ""
                        }
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      async function updateStatus(id, action) {
        const res = await fetch(`/api/absensi/${id}/${action}`, { method: "POST" });
        if (res.ok) {
          alert(action === "approve" ? "Status Disetujui" : "Status Ditolak");
          loadAbsensi();
        } else {
          alert("Gagal mengubah status. Mungkin status sudah diubah.");
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        sessionStorage.removeItem("userId");
        sessionStorage.removeItem("userNama");
        sessionStorage.removeItem("userRole");
        window.location.href = "/";
      });

      loadAbsensi();
    </script>
  </body>
</html>
