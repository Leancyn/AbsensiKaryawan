<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="layout/admin-layout :: layout(
    title='Absensi Karyawan',
    menu='absensi',
    content=~{::content}
  )"
>
  <th:block th:fragment="content">
    <div class="page-header mb-3">
      <h4 class="page-title">Absensi Karyawan</h4>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Nama</th>
                <th>Foto</th>
                <th>Waktu</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Status</th>
                <th class="text-end">Aksi</th>
              </tr>
            </thead>
            <tbody id="absensiBody">
              <tr>
                <td colspan="8" class="text-center text-muted p-4">Memuat data absensi...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script>
      async function loadAbsensi() {
        try {
          const res = await fetch("/api/absensi/all");
          if (!res.ok) throw new Error("Gagal mengambil data");

          const data = await res.json();
          const body = document.getElementById("absensiBody");
          body.innerHTML = "";

          if (data.length === 0) {
            body.innerHTML = `
              <tr>
                <td colspan="8" class="text-center text-muted p-4">
                  Tidak ada data absensi
                </td>
              </tr>
            `;
            return;
          }

          data.forEach((a) => {
            const badge = a.status === "approved" ? "success" : a.status === "rejected" ? "danger" : "warning";

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${a.id}</td>
              <td>${a.userNama}</td>
              <td>
                ${a.fotoBase64 ? `<img src="${a.fotoBase64}" class="rounded" style="width:42px">` : "-"}
              </td>
              <td>${new Date(a.timestamp).toLocaleString()}</td>
              <td>
                ${a.latitude ?? "-"} 
                ${a.latitude ? `<a href="https://www.google.com/maps?q=${a.latitude},${a.longitude}" target="_blank" class="ms-1">ðŸ“Œ</a>` : ""}
              </td>
              <td>${a.longitude ?? "-"}</td>
              <td>
                <span class="badge bg-${badge}">
                  ${a.status.toUpperCase()}
                </span>
              </td>
              <td class="text-end">
                ${
                  a.status === "pending"
                    ? `
                      <button class="btn btn-success btn-sm" onclick="updateStatus(${a.id}, 'approve')">
                        Approve
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="updateStatus(${a.id}, 'reject')">
                        Reject
                      </button>
                    `
                    : "-"
                }
              </td>
            `;
            body.appendChild(tr);
          });
        } catch (e) {
          document.getElementById("absensiBody").innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-danger p-4">
                ${e.message}
              </td>
            </tr>
          `;
        }
      }

      async function updateStatus(id, action) {
        const res = await fetch(`/api/absensi/${id}/${action}`, {
          method: "POST",
        });
        if (res.ok) loadAbsensi();
        else alert("Gagal update status");
      }

      // Load absensi saat halaman dibuka
      loadAbsensi();
    </script>
  </th:block>
</html>
