<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <style>
      /* ===== CAMERA STYLING ===== */
      .camera-wrapper {
        display: flex;
        justify-content: center;
      }

      .camera-frame {
        width: 260px;
        aspect-ratio: 3 / 4;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .camera-overlay {
        position: absolute;
        inset: 0;
        border: 3px solid rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        pointer-events: none;
      }

      .camera-icon {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 18px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 6px;
        border-radius: 6px;
      }

      .camera-loading {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <div
      th:replace="layout/user-layout :: layout(
        title='Absensi',
        menu='absensi',
        content=~{::content}
      )"
    >
      <th:block th:fragment="content">
        <div class="page-header">
          <h4 class="page-title">Absensi</h4>
        </div>

        <!-- STATUS -->
        <div class="alert alert-info mt-3" id="statusBox">Mengecek status absensi hari ini...</div>

        <!-- ABSENSI -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <!-- CAMERA -->
            <div class="camera-wrapper hidden mt-2" id="cameraWrapper">
              <div class="camera-frame">
                <video id="video" autoplay playsinline class="camera-video"></video>

                <div class="camera-overlay"></div>
                <div class="camera-icon">ðŸ“·</div>

                <div id="cameraLoading" class="camera-loading hidden">Menyalakan kamera...</div>
              </div>
            </div>

            <!-- BUTTON -->
            <div class="mt-3 d-flex gap-2 flex-wrap">
              <button id="cameraBtn" class="btn btn-primary btn-sm">Nyalakan Kamera</button>
              <button id="absenBtn" class="btn btn-success btn-sm" disabled>Absen</button>
            </div>

            <small class="text-muted d-block mt-2"> Foto dan lokasi diambil secara real-time </small>
          </div>
        </div>

        <!-- RIWAYAT -->
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h6 class="card-title mb-3">Riwayat Absensi</h6>

            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Tanggal</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="historyBody">
                  <tr>
                    <td colspan="2" class="text-center text-muted">Memuat riwayat...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </th:block>
    </div>

    <!-- SCRIPT -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const video = document.getElementById("video");
        const cameraBtn = document.getElementById("cameraBtn");
        const absenBtn = document.getElementById("absenBtn");
        const historyBody = document.getElementById("historyBody");
        const statusBox = document.getElementById("statusBox");
        const cameraWrapper = document.getElementById("cameraWrapper");
        const cameraLoading = document.getElementById("cameraLoading");

        let latitude = null;
        let longitude = null;
        let stream = null;
        let sudahAbsenHariIni = false;

        async function cekStatusHariIni() {
          const res = await fetch("/api/absensi/status-hari-ini");
          const status = await res.text();

          if (status === "belum") {
            statusBox.className = "alert alert-warning";
            statusBox.innerText = "Anda belum melakukan absensi hari ini";
            sudahAbsenHariIni = false;
          } else if (status === "pending") {
            statusBox.className = "alert alert-secondary";
            statusBox.innerText = "Absensi menunggu approval admin";
            sudahAbsenHariIni = true;
          } else if (status === "approved") {
            statusBox.className = "alert alert-success";
            statusBox.innerText = "Anda sudah absen hari ini";
            sudahAbsenHariIni = true;
          } else if (status === "rejected") {
            statusBox.className = "alert alert-danger";
            statusBox.innerText = "Absensi ditolak, silakan absen ulang";
            sudahAbsenHariIni = false;
          }

          cameraBtn.disabled = sudahAbsenHariIni;
          absenBtn.disabled = true;
        }

        async function loadHistory() {
          const res = await fetch("/api/absensi/riwayat");
          const data = await res.json();
          historyBody.innerHTML = "";

          if (!data.length) {
            historyBody.innerHTML = `
              <tr>
                <td colspan="2" class="text-center text-muted">
                  Belum ada data
                </td>
              </tr>`;
            return;
          }

          data.forEach((a) => {
            const badge = a.status === "approved" ? "success" : a.status === "rejected" ? "danger" : "warning";

            const label = a.status === "approved" ? "Hadir" : a.status === "rejected" ? "Ditolak" : "Menunggu";

            historyBody.innerHTML += `
              <tr>
                <td>${new Date(a.timestamp).toLocaleString()}</td>
                <td><span class="badge bg-${badge}">${label}</span></td>
              </tr>`;
          });
        }

        function getLocation() {
          return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                latitude = pos.coords.latitude;
                longitude = pos.coords.longitude;
                resolve();
              },
              () => reject("Izin lokasi ditolak"),
              { enableHighAccuracy: true }
            );
          });
        }

        cameraBtn.onclick = async () => {
          try {
            cameraBtn.disabled = true;
            cameraWrapper.classList.remove("hidden");
            cameraLoading.classList.remove("hidden");

            await getLocation();
            stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "user" },
            });

            video.srcObject = stream;
            cameraLoading.classList.add("hidden");
            absenBtn.disabled = false;
          } catch (e) {
            alert(e);
            cameraBtn.disabled = false;
            cameraWrapper.classList.add("hidden");
            cameraLoading.classList.add("hidden");
          }
        };

        absenBtn.onclick = async () => {
          absenBtn.disabled = true;

          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext("2d").drawImage(video, 0, 0);

          const blob = await new Promise((r) => canvas.toBlob(r, "image/jpeg"));

          const form = new FormData();
          form.append("latitude", latitude);
          form.append("longitude", longitude);
          form.append("foto", blob, "absen.jpg");

          const res = await fetch("/api/absensi/checkin", {
            method: "POST",
            body: form,
          });

          if (!res.ok) {
            alert(await res.text());
            absenBtn.disabled = false;
            return;
          }

          alert("Absensi berhasil");

          stream.getTracks().forEach((t) => t.stop());
          cameraWrapper.classList.add("hidden");

          await cekStatusHariIni();
          await loadHistory();
        };

        cekStatusHariIni();
        loadHistory();
      });
    </script>
  </body>
</html>
